#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Visualize the camera positions estimated by Colmap tasks.
"""

import argparse
from pathlib import Path

from plant3dvision.tasks.colmap import pose_estimation_figure
from plant3dvision.tasks.colmap import get_cnc_poses
from plant3dvision.tasks.colmap import compute_colmap_poses_from_camera_json
from plantdb.fsdb import FSDB


def parsing():
    DESC = """Visualize the camera positions estimated by Colmap tasks."""
    parser = argparse.ArgumentParser(description=DESC)

    parser.add_argument("dataset",
                        help="Path to the dataset.")

    return parser


def main(args):
    dataset_path = Path(args.dataset)  # `/path/to/romi_db/scan_id`
    db_location = dataset_path.parent  # `/path/to/romi_db`
    scan_name = dataset_path.name      # `scan_id`
    # - Connect to database:
    db = FSDB(db_location)
    db.connect()
    # - Get the dataset corresponding to the selected scan:
    dataset = db.get_scan(scan_name)
    # - Get the CNC poses:
    cnc_poses = get_cnc_poses(dataset)
    # - Get the COLMAP poses:
    colmap_poses = compute_colmap_poses_from_camera_json(dataset)
    # - Generate the calibration figure:
    pose_estimation_figure(cnc_poses, colmap_poses, pred_scan_id=scan_name, ref_scan_id='Colmap')
    db.disconnect()


def run():
    # - Parse the input arguments to variables:
    parser = parsing()
    args = parser.parse_args()
    main(args)


if __name__ == '__main__':
    run()
